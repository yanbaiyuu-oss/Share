import akshare as ak
import pandas as pd
import time


def fetch_and_write_individual_info(output_filename="individual_info_brief.txt"):

    print("æ­£åœ¨è·å–æ‰€æœ‰è‚¡ç¥¨ä»£ç  ")
    try:
        stock_spot_df = ak.stock_zh_a_spot()
    except Exception as e:
        print(f"{e}")
        return

    stock_codes = stock_spot_df['ä»£ç '].astype(str).tolist()

    final_info_list = []

    print(f"å‘ç° {len(stock_codes)} ä¸ªè‚¡ç¥¨ã€‚å¼€å§‹æŸ¥è¯¢ä¸ªè‚¡ä¿¡æ¯")

    total_stocks = len(stock_codes)


    for index, code in enumerate(stock_codes, 1):
        print(f"æ­£åœ¨å¤„ç† {index}/{total_stocks}: è‚¡ç¥¨ä»£ç  {code}...", end='\r', flush=True)
        try:
            individual_df = ak.stock_individual_info_em(symbol=code)

            if not individual_df.empty:
                info_dict = individual_df.iloc[0].to_dict()
                selected_info = {
                    'è‚¡ç¥¨ä»£ç ': code,
                    'è‚¡ç¥¨ç®€ç§°': info_dict.get('è‚¡ç¥¨ç®€ç§°', info_dict.get('åç§°', 'N/A')),  # å°è¯•è·å– 'è‚¡ç¥¨ç®€ç§°' æˆ– 'åç§°'
                    'æ‰€å±è¡Œä¸š': info_dict.get('æ‰€å±è¡Œä¸š', 'N/A')
                }


                if selected_info['æ‰€å±è¡Œä¸š'] != 'N/A':
                    final_info_list.append(selected_info)


            time.sleep(0.05)

        except Exception as e:

            print(f"\n   - âš ï¸ è­¦å‘Š: æŸ¥è¯¢è‚¡ç¥¨ {code} çš„ä¸ªè‚¡ä¿¡æ¯å¤±è´¥: {e}. è·³è¿‡.")
            time.sleep(0.1)

    print("\nâœ… æ­¥éª¤ 2 å®Œæˆ: æ‰€æœ‰ä¸ªè‚¡ä¿¡æ¯æŸ¥è¯¢å®Œæ¯•ã€‚")


    final_df = pd.DataFrame(final_info_list)

    if final_df.empty:
        print("âŒ é”™è¯¯: æœªèƒ½è·å–åˆ°ä»»ä½•æœ‰æ•ˆçš„ä¸ªè‚¡ä¿¡æ¯ï¼Œæ— æ³•å†™å…¥æ–‡ä»¶ã€‚")
        return

    print(f"ğŸ“ æ­¥éª¤ 3: æ­£åœ¨å°† {len(final_df)} æ¡æ•°æ®å†™å…¥æ–‡ä»¶: {output_filename}...")

    try:
        # å°†æœ€ç»ˆçš„ DataFrame å†™å…¥æœ¬åœ°æ–‡ä»¶
        final_df.to_csv(
            output_filename,
            sep='\t',
            index=False,
            encoding='utf-8',
            header=True
        )
        print(f"ğŸ‰ æˆåŠŸ: æ•°æ®å·²å†™å…¥åˆ°æ–‡ä»¶: {output_filename}")
    except Exception as e:
        print(f"âŒ é”™è¯¯: å†™å…¥æ–‡ä»¶å¤±è´¥: {e}")


# æ‰§è¡Œä¸»å‡½æ•°
if __name__ == "__main__":
    # ä½¿ç”¨ç”¨æˆ·æŒ‡å®šçš„åŸå§‹æ–‡ä»¶å
    fetch_and_write_individual_info(output_filename="Dict_Share_Industry.txt")
