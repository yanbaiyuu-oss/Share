import akshare as ak
import pandas as pd
import time

def fetch_and_write_individual_info(output_filename="individual_info_brief.txt"):
    """
    è·å– A è‚¡ä»£ç ï¼Œé€ä¸€æŸ¥è¯¢ä¸ªè‚¡ä¿¡æ¯ï¼Œå¹¶ä»…æå– 'ä»£ç ', 'ç®€ç§°', 'è¡Œä¸š' å†™å…¥æ–‡ä»¶ã€‚
    """
    print("ğŸš€ æ­¥éª¤ 1: æ­£åœ¨è·å–æ‰€æœ‰ A è‚¡ä»£ç  (stock_zh_a_spot_em)...")
    try:
        # è·å–æ‰€æœ‰ A è‚¡å®æ—¶è¡Œæƒ…æ•°æ®
        stock_spot_df = ak.stock_zh_a_spot_em()
    except Exception as e:
        print(f"âŒ é”™è¯¯: è·å– stock_zh_a_spot_em å¤±è´¥: {e}")
        return

    # ä»…ä¿ç•™ 'ä»£ç ' åˆ—ç”¨äºåç»­æŸ¥è¯¢
    if 'ä»£ç ' not in stock_spot_df.columns:
        print("âŒ é”™è¯¯: å®æ—¶è¡Œæƒ…æ•°æ®ä¸­æœªæ‰¾åˆ° 'ä»£ç ' åˆ—ã€‚")
        return

    stock_codes = stock_spot_df['ä»£ç '].astype(str).tolist()
    
    # ç”¨äºå­˜å‚¨æœ€ç»ˆç›®æ ‡ä¿¡æ¯çš„åˆ—è¡¨
    final_info_list = []
    
    print(f"ğŸ“ˆ æ­¥éª¤ 2: å‘ç° {len(stock_codes)} ä¸ªè‚¡ç¥¨ã€‚å¼€å§‹é€ä¸€æŸ¥è¯¢ä¸ªè‚¡ä¿¡æ¯ (STOCK_INDIVIDUAL_INFO_EM)...")
    
    total_stocks = len(stock_codes)
    
    # éå†æ‰€æœ‰è‚¡ç¥¨ä»£ç ï¼ŒæŸ¥è¯¢ä¸ªè‚¡ä¿¡æ¯
    for index, code in enumerate(stock_codes, 1):
        print(f"   - æ­£åœ¨å¤„ç† {index}/{total_stocks}: è‚¡ç¥¨ä»£ç  {code}...", end='\r', flush=True)
        try:
            # æŸ¥è¯¢ä¸ªè‚¡ä¿¡æ¯
            individual_df = ak.stock_individual_info_em(symbol=code)
            
            if not individual_df.empty:
                # å‡è®¾åªå–ç¬¬ä¸€æ¡æ•°æ®
                info_dict = individual_df.iloc[0].to_dict()
                
                # æå–ç›®æ ‡å­—æ®µã€‚æ³¨æ„ï¼š
                # 'è‚¡ç¥¨ä»£ç ' åœ¨ akshare çš„è¿”å›ä¸­é€šå¸¸æ˜¯ 'ä»£ç '
                # 'è‚¡ç¥¨ç®€ç§°' åœ¨ akshare çš„è¿”å›ä¸­å¯èƒ½æ˜¯ 'åç§°' æˆ– 'ç®€ç§°'
                # 'è¡Œä¸š' åœ¨ akshare çš„è¿”å›ä¸­å¯èƒ½æ˜¯ 'æ‰€å±è¡Œä¸š'
                # è¿™é‡Œæ ¹æ®ç»éªŒä½¿ç”¨å¸¸è§åˆ—åï¼Œè‹¥è¿è¡Œå‡ºé”™è¯·æ ¹æ®å®é™…è¿”å›è°ƒæ•´ã€‚
                
                selected_info = {
                    'è‚¡ç¥¨ä»£ç ': code,
                    'è‚¡ç¥¨ç®€ç§°': info_dict.get('è‚¡ç¥¨ç®€ç§°', info_dict.get('åç§°', 'N/A')), # å°è¯•è·å– 'è‚¡ç¥¨ç®€ç§°' æˆ– 'åç§°'
                    'æ‰€å±è¡Œä¸š': info_dict.get('æ‰€å±è¡Œä¸š', 'N/A')
                }
                
                # åªæœ‰å½“ 'æ‰€å±è¡Œä¸š' ä¸æ˜¯ 'N/A' æ—¶æ‰è§†ä¸ºæœ‰æ•ˆæ•°æ®æ·»åŠ 
                if selected_info['æ‰€å±è¡Œä¸š'] != 'N/A':
                    final_info_list.append(selected_info)
            
            # å»ºè®®æ·»åŠ çŸ­æš‚å»¶è¿Ÿ
            time.sleep(0.05) 
            
        except Exception as e:
            # é‡åˆ°é”™è¯¯æ—¶ä¹Ÿç¨ä½œç­‰å¾…ï¼Œå¹¶æ‰“å°è­¦å‘Š
            print(f"\n   - âš ï¸ è­¦å‘Š: æŸ¥è¯¢è‚¡ç¥¨ {code} çš„ä¸ªè‚¡ä¿¡æ¯å¤±è´¥: {e}. è·³è¿‡.")
            time.sleep(0.1)

    print("\nâœ… æ­¥éª¤ 2 å®Œæˆ: æ‰€æœ‰ä¸ªè‚¡ä¿¡æ¯æŸ¥è¯¢å®Œæ¯•ã€‚")

    # è½¬æ¢ä¸º DataFrame
    final_df = pd.DataFrame(final_info_list)
    
    if final_df.empty:
        print("âŒ é”™è¯¯: æœªèƒ½è·å–åˆ°ä»»ä½•æœ‰æ•ˆçš„ä¸ªè‚¡ä¿¡æ¯ï¼Œæ— æ³•å†™å…¥æ–‡ä»¶ã€‚")
        return

    print(f"ğŸ“ æ­¥éª¤ 3: æ­£åœ¨å°† {len(final_df)} æ¡æ•°æ®å†™å…¥æ–‡ä»¶: {output_filename}...")
    
    try:
        # å°†æœ€ç»ˆçš„ DataFrame å†™å…¥æœ¬åœ°æ–‡ä»¶
        final_df.to_csv(
            output_filename, 
            sep='\t', 
            index=False, 
            encoding='utf-8', 
            header=True
        )
        print(f"ğŸ‰ æˆåŠŸ: æ•°æ®å·²å†™å…¥åˆ°æ–‡ä»¶: {output_filename}")
    except Exception as e:
        print(f"âŒ é”™è¯¯: å†™å…¥æ–‡ä»¶å¤±è´¥: {e}")

# æ‰§è¡Œä¸»å‡½æ•°
if __name__ == "__main__":
    # ä½¿ç”¨ç”¨æˆ·æŒ‡å®šçš„åŸå§‹æ–‡ä»¶å
    fetch_and_write_individual_info(output_filename="spot.txt")
