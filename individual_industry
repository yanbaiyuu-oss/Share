import akshare as ak
import pandas as pd
import time

def fetch_and_write_individual_info_cleaned(output_filename="individual_info_cleaned.txt"):
    """
    è·å– A è‚¡ä»£ç ï¼Œè¿›è¡Œæ¸…æ´—ï¼ˆä¿ç•™ç‰¹å®šå‰ç¼€å¹¶åˆ é™¤å‰ç¼€ï¼‰ï¼Œé€ä¸€æŸ¥è¯¢ä¸ªè‚¡ä¿¡æ¯ï¼Œ
    å¹¶ä»…æå– 'ä»£ç ', 'ç®€ç§°', 'è¡Œä¸š' å†™å…¥æ–‡ä»¶ã€‚
    """
    print("ğŸš€ æ­¥éª¤ 1: æ­£åœ¨è·å–æ‰€æœ‰ A è‚¡ä»£ç  (stock_zh_a_spot_em)...")
    try:
        stock_spot_df = ak.stock_zh_a_spot_em()
    except Exception as e:
        print(f"âŒ é”™è¯¯: è·å– stock_zh_a_spot_em å¤±è´¥: {e}")
        return

    if 'ä»£ç ' not in stock_spot_df.columns:
        print("âŒ é”™è¯¯: å®æ—¶è¡Œæƒ…æ•°æ®ä¸­æœªæ‰¾åˆ° 'ä»£ç ' åˆ—ã€‚")
        return

    # æå–æ‰€æœ‰ä»£ç å¹¶è½¬æ¢ä¸ºå­—ç¬¦ä¸²
    stock_codes_raw = stock_spot_df['ä»£ç '].astype(str).tolist()
    initial_count = len(stock_codes_raw)
    
    print(f"ğŸ§¹ æ­¥éª¤ 1.5: å¯¹ {initial_count} ä¸ªè‚¡ç¥¨ä»£ç è¿›è¡Œæ¸…æ´—å’Œæ ¼å¼åŒ–...")
    
    # --- ä»£ç æ¸…æ´—æ­¥éª¤ ---
    
    cleaned_codes = []
    prefix_list = ['sz', 'sh', 'SZ', 'SH']
    
    for code in stock_codes_raw:
        # 1. æ£€æŸ¥æ˜¯å¦ä»¥æŒ‡å®šå‰ç¼€å¼€å¤´ï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰
        # ä½¿ç”¨ str.startswith() ç»“åˆå°å†™æˆ–å¤§å†™æ£€æŸ¥ï¼Œæˆ–è€…æ›´ç²¾ç¡®åœ°å¾ªç¯æ£€æŸ¥
        is_valid = False
        prefix_to_remove = None
        
        for prefix in prefix_list:
            if code.startswith(prefix):
                is_valid = True
                prefix_to_remove = prefix
                break
        
        if is_valid:
            # 2. åˆ é™¤å‰ç¼€ï¼Œåªä¿ç•™æ•°å­—
            numerical_code = code[len(prefix_to_remove):]
            cleaned_codes.append(numerical_code)

    stock_codes = cleaned_codes
    
    print(f"âœ… æ¸…æ´—å®Œæˆã€‚æœ‰æ•ˆä»£ç æ•°é‡ï¼š{len(stock_codes)} ä¸ªã€‚")
    # ------------------
    
    final_info_list = []
    total_stocks = len(stock_codes)
    
    print(f"ğŸ“ˆ æ­¥éª¤ 2: å¼€å§‹é€ä¸€æŸ¥è¯¢ {total_stocks} ä¸ªæ¸…æ´—åçš„è‚¡ç¥¨ä»£ç çš„ä¸ªè‚¡ä¿¡æ¯ (STOCK_INDIVIDUAL_INFO_EM)...")
    
    # éå†æ‰€æœ‰æ¸…æ´—åçš„è‚¡ç¥¨ä»£ç ï¼ŒæŸ¥è¯¢ä¸ªè‚¡ä¿¡æ¯
    for index, code in enumerate(stock_codes, 1):
        # æ³¨æ„: STOCK_INDIVIDUAL_INFO_EM æ¥å£è¦æ±‚ä¼ å…¥çº¯æ•°å­—ä»£ç 
        print(f"   - æ­£åœ¨å¤„ç† {index}/{total_stocks}: è‚¡ç¥¨ä»£ç  {code}...", end='\r', flush=True)
        try:
            # æŸ¥è¯¢ä¸ªè‚¡ä¿¡æ¯
            individual_df = ak.stock_individual_info_em(symbol=code)
            
            if not individual_df.empty:
                info_dict = individual_df.iloc[0].to_dict()
                
                # æå–ç›®æ ‡å­—æ®µ
                selected_info = {
                    'è‚¡ç¥¨ä»£ç ': code,
                    'è‚¡ç¥¨ç®€ç§°': info_dict.get('è‚¡ç¥¨ç®€ç§°', info_dict.get('åç§°', 'N/A')),
                    'æ‰€å±è¡Œä¸š': info_dict.get('æ‰€å±è¡Œä¸š', 'N/A')
                }
                
                # åªæœ‰å½“ 'æ‰€å±è¡Œä¸š' ä¸æ˜¯ 'N/A' æ—¶æ‰è§†ä¸ºæœ‰æ•ˆæ•°æ®æ·»åŠ 
                if selected_info['æ‰€å±è¡Œä¸š'] != 'N/A':
                    final_info_list.append(selected_info)
            
            # å»ºè®®æ·»åŠ çŸ­æš‚å»¶è¿Ÿ
            time.sleep(0.05) 
            
        except Exception as e:
            # é‡åˆ°é”™è¯¯æ—¶ä¹Ÿç¨ä½œç­‰å¾…ï¼Œå¹¶æ‰“å°è­¦å‘Š
            print(f"\n   - âš ï¸ è­¦å‘Š: æŸ¥è¯¢è‚¡ç¥¨ {code} çš„ä¸ªè‚¡ä¿¡æ¯å¤±è´¥: {e}. è·³è¿‡.")
            time.sleep(0.1)

    print("\nâœ… æ­¥éª¤ 2 å®Œæˆ: æ‰€æœ‰ä¸ªè‚¡ä¿¡æ¯æŸ¥è¯¢å®Œæ¯•ã€‚")

    final_df = pd.DataFrame(final_info_list)
    
    if final_df.empty:
        print("âŒ é”™è¯¯: æœªèƒ½è·å–åˆ°ä»»ä½•æœ‰æ•ˆçš„ä¸ªè‚¡ä¿¡æ¯ï¼Œæ— æ³•å†™å…¥æ–‡ä»¶ã€‚")
        return

    print(f"ğŸ“ æ­¥éª¤ 3: æ­£åœ¨å°† {len(final_df)} æ¡æ•°æ®å†™å…¥æ–‡ä»¶: {output_filename}...")
    
    try:
        final_df.to_csv(
            output_filename, 
            sep='\t', 
            index=False, 
            encoding='utf-8', 
            header=True
        )
        print(f"ğŸ‰ æˆåŠŸ: æ•°æ®å·²å†™å…¥åˆ°æ–‡ä»¶: {output_filename}")
    except Exception as e:
        print(f"âŒ é”™è¯¯: å†™å…¥æ–‡ä»¶å¤±è´¥: {e}")

# æ‰§è¡Œä¸»å‡½æ•°
if __name__ == "__main__":
    fetch_and_write_individual_info_cleaned(output_filename="spot_cleaned.txt")
